<template>
    <div class="backdrop" onclick={closePopup}></div>

    <div class="popup" onclick={stopProp}>
        <div class="header">
            <span>Select Field ({objectName})</span>
            <button class="close" onclick={closePopup}>Ã—</button>
        </div>

        <div class="panels-row">
            <template for:each={panelsView} for:item="p">
                <div key={p.idx} class="panel">

                    <div class="panel-header">
                        <div class="panel-title">{p.objectName}</div>

                        <input class="panel-search"
                               type="text"
                               placeholder="Search fields..."
                               value={p.search}
                               data-panel={p.idx}
                               oninput={onSearchInput} />
                    </div>

                    <div class="panel-controls">
                        <button class={p.allBtnClass}
                                data-panel={p.idx}
                                data-mode="all"
                                onclick={changeMode}>
                            All
                        </button>

                        <button class={p.parentBtnClass}
                                data-panel={p.idx}
                                data-mode="parent"
                                onclick={changeMode}>
                            Parent
                        </button>

                        <button class={p.childBtnClass}
                                data-panel={p.idx}
                                data-mode="child"
                                onclick={changeMode}>
                            Child
                        </button>
                    </div>

                    <template if:true={p.showFields}>
                        <div class="panel-section">
                            <div class="section-title">Fields</div>
                            <div class="section-list">
                                <template for:each={p.filteredFieldsGroup} for:item="fld">
                                    <div key={fld.name} class="field-row">
                                        <div class="field-name"
                                             data-name={fld.name}
                                             data-panel={p.idx}
                                             onclick={chooseField}>
                                            {fld.name}
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <template if:true={p.showParents}>
                        <div class="panel-section">
                            <div class="section-title">Parent Relationships</div>
                            <div class="section-list">
                                <template for:each={p.filteredParentGroup} for:item="fld">
                                    <div key={fld.name} class="field-row">
                                        <div class="field-name"
                                             data-name={fld.name}
                                             data-panel={p.idx}
                                             onclick={chooseField}>
                                            {fld.name}
                                        </div>

                                        <button class="expand-btn"
                                                data-name={fld.name}
                                                data-panel={p.idx}
                                                onclick={expandRelation}>
                                            &gt;
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <template if:true={p.showChildren}>
                        <div class="panel-section">
                            <div class="section-title">Child Relationships</div>
                            <div class="section-list">
                                <template for:each={p.filteredChildGroup} for:item="fld">
                                    <div key={fld.name} class="field-row">
                                        <div class="field-name"
                                             data-name={fld.name}
                                             data-panel={p.idx}
                                             onclick={chooseField}>
                                            {fld.name}
                                        </div>

                                        <button class="expand-btn"
                                                data-name={fld.name}
                                                data-panel={p.idx}
                                                onclick={expandRelation}>
                                            &gt;
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                </div>
            </template>
        </div>
    </div>
</template>